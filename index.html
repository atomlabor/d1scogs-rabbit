<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=240,height=282,viewport-fit=cover,user-scalable=no,maximum-scale=1.0,initial-scale=1.0"/>
  <title>Discogs R1</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      background: #1a1a1a;
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: grid; place-items: center; color: #e0e0e0;
    }
    .frame { width: 240px; height: 282px; background: #0a0a0a; border: 1px solid #333; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
    .logo { padding: 16px 0 12px; text-align: center; font-size: 16px; font-weight: 700; color: #ff6a00; letter-spacing: .5px; }
    .card { flex: 1; padding: 0 12px 12px; display: flex; flex-direction: column; gap: 10px; }
    .field { display: flex; flex-direction: column; gap: 4px; }
    label { font-size: 11px; color: #bbb; font-weight: 500; }
    input { width: 100%; padding: 10px; background: #151515; border: 1px solid #333; border-radius: 6px; color: #e0e0e0; font-size: 13px; outline: none; }
    input:focus { border-color: #ff6a00; }
    .btn { width: 100%; padding: 12px; background: #ff6a00; border: none; border-radius: 10px; color: #000; font-size: 14px; font-weight: 800; cursor: pointer; margin-top: 2px; }
    .btn:active { transform: translateY(1px); }
    .status { font-size: 11px; text-align: center; min-height: 16px; color: #999; }
    .status.success { color: #4ade80; } .status.error { color: #f87171; }
    .logged-in { display: none; flex-direction: column; gap: 8px; }
    .logged-in.active { display: flex; }
    .welcome { font-size: 13px; text-align: center; color: #4ade80; font-weight: 700; }
    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .btn-secondary { padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 10px; color: #e0e0e0; font-size: 12px; font-weight: 700; cursor: pointer; }
    .btn-secondary:active { transform: translateY(1px); }
    /* Collection */
    #collectionView { display: none; flex: 1; overflow: hidden; gap: 6px; }
    #collectionView.active { display: flex; flex-direction: column; }
    .search { display: flex; gap: 6px; }
    .list { flex: 1; overflow-y: auto; border: 1px solid #222; border-radius: 8px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 6px; padding: 8px; border-bottom: 1px solid #222; }
    .row:last-child { border-bottom: none; }
    .title { font-size: 12px; font-weight: 700; }
    .meta { font-size: 11px; color: #aaa; }
    /* Scan overlay */
    #scanOverlay { position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.8); }
    #scanOverlay.active { display: grid; }
    .scan-card { width: 220px; background: #0f0f0f; border: 1px solid #333; border-radius: 12px; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
    .scan-area { height: 120px; border: 2px dashed #444; border-radius: 10px; display: grid; place-items: center; color: #bbb; font-size: 12px; }
    .scan-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  </style>
</head>
<body>
  <div class="frame">
    <div class="logo">DISCOGS R1</div>

    <div class="card" id="loginView">
      <div class="field">
        <label for="token">Token</label>
        <input id="token" placeholder="Personal Access Token" type="text"/>
      </div>
      <div class="field">
        <label for="username">Username</label>
        <input id="username" placeholder="Discogs Username" type="text"/>
      </div>
      <button class="btn" onclick="window.login()">Login</button>
      <div class="status" id="status"></div>
    </div>

    <div class="card logged-in" id="loggedInView">
      <div class="welcome" id="welcome">Login erfolgreich</div>
      <div class="actions">
        <button class="btn-secondary" onclick="window.toggleCollection(true)">Collection</button>
        <button class="btn-secondary" onclick="window.openScan()">Scan</button>
      </div>
      <div id="collectionView">
        <div class="search">
          <input id="searchInput" type="text" placeholder="Suche in Collection" oninput="window.renderCollection()"/>
          <button class="btn-secondary" onclick="window.clearSearch()">Clear</button>
        </div>
        <div class="list" id="collectionList"></div>
      </div>
      <button class="btn-secondary" onclick="window.logout()">Logout</button>
    </div>
  </div>

  <!-- Scan Overlay -->
  <div id="scanOverlay" role="dialog" aria-modal="true" aria-label="Scan">
    <div class="scan-card">
      <div class="scan-area" id="scanArea">Barcode/QR Dummy</div>
      <div class="field">
        <label for="codeInput">Code (Dummy)</label>
        <input id="codeInput" placeholder="z.B. 4029759123456" type="text"/>
      </div>
      <div class="field">
        <label for="titleInput">Titel</label>
        <input id="titleInput" placeholder="Albumtitel" type="text"/>
      </div>
      <div class="field">
        <label for="artistInput">Artist</label>
        <input id="artistInput" placeholder="Künstler" type="text"/>
      </div>
      <div class="scan-actions">
        <button class="btn-secondary" onclick="window.closeScan()">Abbrechen</button>
        <button class="btn" onclick="window.addScanned()">Hinzufügen</button>
      </div>
    </div>
  </div>

  <script>
    // Simple store using localStorage
    const store = {
      get token() { return localStorage.getItem('discogs_token') || ''; },
      set token(v) { localStorage.setItem('discogs_token', v); },
      get user() { return localStorage.getItem('discogs_user') || ''; },
      set user(v) { localStorage.setItem('discogs_user', v); },
      get collection() {
        try { return JSON.parse(localStorage.getItem('discogs_collection')) || [] } catch { return [] }
      },
      set collection(v) { localStorage.setItem('discogs_collection', JSON.stringify(v)) }
    };

    // Dummy initial collection
    if (!localStorage.getItem('discogs_collection')) {
      store.collection = [
        { id: 'COL-001', title: 'Discovery', artist: 'Daft Punk', year: 2001 },
        { id: 'COL-002', title: 'Random Access Memories', artist: 'Daft Punk', year: 2013 },
        { id: 'COL-003', title: 'In Rainbows', artist: 'Radiohead', year: 2007 },
      ];
    }

    function setStatus(text, type = '') {
      const el = document.getElementById('status');
      if (el) { el.textContent = text; el.className = 'status ' + type; }
    }
    function showView(viewId) {
      const login = document.getElementById('loginView');
      const logged = document.getElementById('loggedInView');
      if (login && logged) {
        login.style.display = viewId === 'login' ? 'flex' : 'none';
        logged.classList.toggle('active', viewId === 'loggedIn');
      }
      // Only show collection section when logged in
      document.getElementById('collectionView')?.classList.remove('active');
    }

    // Login remains unchanged (calls Discogs API)
    window.login = async function() {
      const token = document.getElementById('token').value.trim();
      const username = document.getElementById('username').value.trim();
      if (!token || !username) { setStatus('Bitte Token und Username eingeben', 'error'); return; }
      setStatus('Anmeldung läuft...');
      try {
        const response = await fetch(`https://api.discogs.com/users/${encodeURIComponent(username)}`, {
          headers: { 'Authorization': `Discogs token=${token}`, 'User-Agent': 'DiscogsR1/1.0' }
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        if (data && data.username) {
          store.token = token; store.user = username;
          document.getElementById('welcome').textContent = `Login erfolgreich: ${data.username}`;
          showView('loggedIn'); setStatus('');
        } else { throw new Error('Ungültige API-Antwort'); }
      } catch (error) { setStatus(`Fehler: ${error.message}`, 'error'); }
    };

    window.logout = function() {
      store.token = ''; store.user = '';
      document.getElementById('token').value = '';
      document.getElementById('username').value = '';
      showView('login'); setStatus('Abgemeldet');
    }

    // Collection rendering/search
    window.toggleCollection = function(show) {
      if (!store.token) { setStatus('Bitte zuerst einloggen', 'error'); return; }
      const v = document.getElementById('collectionView');
      if (v) v.classList.toggle('active', !!show);
      renderCollection();
    }
    window.clearSearch = function(){ const s = document.getElementById('searchInput'); if(s){ s.value=''; renderCollection(); } }
    window.renderCollection = function() {
      const list = document.getElementById('collectionList');
      const term = (document.getElementById('searchInput')?.value || '').toLowerCase();
      const data = store.collection.filter(x =>
        !term || x.title.toLowerCase().includes(term) || x.artist.toLowerCase().includes(term) || (x.year+'' ).includes(term)
      );
      if (!list) return;
      list.innerHTML = data.map(x => `
        <div class="row">
          <div>
            <div class="title">${x.title}</div>
            <div class="meta">${x.artist} • ${x.year}</div>
          </div>
          <div class="meta">${x.id}</div>
        </div>`).join('');
    }

    // Scan overlay and add
    window.openScan = function(){ if(!store.token){ setStatus('Bitte zuerst einloggen', 'error'); return; } document.getElementById('scanOverlay').classList.add('active'); }
    window.closeScan = function(){ document.getElementById('scanOverlay').classList.remove('active'); }
    window.addScanned = function(){
      const code = document.getElementById('codeInput').value.trim() || `CODE-${Date.now()}`;
      const title = document.getElementById('titleInput').value.trim() || 'Unbekanntes Album';
      const artist = document.getElementById('artistInput').value.trim() || 'Unbekannter Künstler';
      const year = new Date().getFullYear();
      const col = store.collection;
      col.unshift({ id: code, title, artist, year });
      store.collection = col;
      document.getElementById('codeInput').value='';
      document.getElementById('titleInput').value='';
      document.getElementById('artistInput').value='';
      window.closeScan();
      window.toggleCollection(true);
      setStatus('Eintrag hinzugefügt', 'success');
    }

    // Auto-login if credentials exist
    window.addEventListener('DOMContentLoaded', () => {
      if (store.token && store.user) {
        document.getElementById('token').value = store.token;
        document.getElementById('username').value = store.user;
        document.getElementById('welcome').textContent = `Willkommen zurück: ${store.user}`;
        showView('loggedIn');
        // show collection by default for R1 quick access
        window.toggleCollection(true);
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Discogs R1 Live Manager</title>

  <!-- Reines natives CSS – Tailwind CDN entfernt. Designsystem im Dokumentkopf. -->
  <style>
    /* R1 Design Tokens */
    :root{
      --r1-bg:#0b0b0f;              /* Dark background */
      --r1-surface:#12131a;         /* Base surface */
      --r1-card:#191a22;            /* Card background */
      --r1-elev:#202230;            /* Elevated surface */
      --r1-neon:#ff6600;            /* Primary neon */
      --r1-neon-2:#ff8a3d;          /* Accent neon */
      --r1-text:#e9e9ee;            /* Main text */
      --r1-dim:#a2a2b0;             /* Dimmed text */
      --r1-border:#2b2c39;          /* Border */
      --r1-danger:#e5484d;
      --radius-xl:20px;
      --radius-lg:14px;
      --radius-md:10px;
      --shadow-1:0 8px 28px rgba(0,0,0,.35);
      --shadow-2:0 14px 38px rgba(0,0,0,.45);
    }

    /* Global Reset & Base */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      background: radial-gradient(1200px 800px at 70% -10%, rgba(255,102,0,.08), transparent 60%), var(--r1-bg);
      color:var(--r1-text);
      line-height:1.6;
      letter-spacing:.2px;
    }
    img{display:block; max-width:100%}
    a{color:var(--r1-neon); text-decoration:none}

    /* Layout helpers (ersetzt Tailwind spacing/containers) */
    .container{max-width: 920px; margin-inline:auto; padding: 28px 18px 80px}
    .stack-4 > * + *{margin-top: 1rem}
    .stack-6 > * + *{margin-top: 1.5rem}
    .stack-8 > * + *{margin-top: 2rem}

    /* Header */
    .app-header{ text-align:center; padding: 10px 0 18px }
    .app-title{
      margin:0; font-size: clamp(28px, 4.6vw, 42px); font-weight:900; letter-spacing:.3px;
      background: linear-gradient(90deg, var(--r1-neon), var(--r1-neon-2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 0 22px rgba(255,102,0,.25);
    }
    .app-sub{ margin:.35rem 0 0; color:var(--r1-dim); font-size: .92rem }

    /* Cards / Surfaces */
    .card{ background: linear-gradient(180deg, var(--r1-card), var(--r1-elev)); border:1px solid var(--r1-border); border-radius:var(--radius-xl); box-shadow:var(--shadow-1) }
    .card.p{ padding: 20px }

    /* Inputs */
    .field{ width:100%; background:#0f1016; color:var(--r1-text); border:2px solid var(--r1-border); border-radius:var(--radius-lg); padding:14px 14px; outline:none; transition: .2s border-color, .2s box-shadow, .2s transform }
    .field::placeholder{ color:#7b7b86 }
    .field:focus{ border-color:var(--r1-neon); box-shadow:0 0 0 3px rgba(255,102,0,.25); transform: translateY(-1px) }

    /* Buttons */
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; border-radius:var(--r1-neon); font-weight:700; cursor:pointer; user-select:none; transition:.2s transform, .2s box-shadow, .2s filter }
    .btn-block{ width:100% }
    .btn-primary{ background: linear-gradient(180deg, var(--r1-neon), #e25700); color:#fff; border:none; border-radius:var(--radius-lg); padding:14px 16px; box-shadow:0 10px 24px rgba(255,102,0,.25) }
    .btn-primary:hover{ transform: translateY(-2px); filter:saturate(1.06) }
    .btn-primary:active{ transform: translateY(0) }
    .btn-ghost{ background:#1b1c27; color:#fff; border:1px solid var(--r1-border); border-radius:var(--radius-lg); padding:12px 14px }
    .btn-ghost:hover{ background:#222336; border-color:#3b3b4a }
    .btn-danger{ background: linear-gradient(180deg, var(--r1-danger), #c73c41); color:#fff; border:none; border-radius:var(--radius-lg); padding:12px 14px }

    /* Tabs */
    .tabs{ display:flex; gap:8px; background:#171722; padding:8px; border-radius:20px; border:1px solid var(--r1-border) }
    .tab{ flex:1; padding:10px 12px; border-radius:12px; color:#cfcfd6; background:transparent; border:0; cursor:pointer }
    .tab.active{ background:var(--r1-neon); color:#fff }
    .tab:not(.active):hover{ background:#212235 }

    /* Collection list */
    .grid{ display:grid; gap:12px }
    .record{ display:flex; gap:12px; align-items:center; padding:12px; border:1px solid var(--r1-border); background: linear-gradient(180deg, #171822, #14141c); border-radius:14px; transition:.18s background,.18s transform,.18s border-color; cursor:pointer }
    .record:hover{ background:#1c1d28; border-color:#3a3a49; transform: translateY(-1px) }
    .record img{ width:52px; height:52px; border-radius:10px; object-fit:cover; border:1px solid #2d2d39 }
    .record .meta{ min-width:0; flex:1 }
    .title{ font-weight:800; color:#f0f0f3; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .sub{ color:#9b9ba6; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .tag{ color:var(--r1-neon); font-size:12px; font-weight:700 }

    /* Scanner */
    .scan-frame{ position:relative; aspect-ratio:16/9; background:black; border-radius:14px; overflow:hidden; display:flex; align-items:center; justify-content:center; box-shadow:var(--shadow-1) }
    .scan-frame .neon{ position:absolute; inset:0; border:3px dashed var(--r1-neon); opacity:.85; margin:12px; border-radius:14px; pointer-events:none }
    .scan-status{ position:absolute; top:8px; left:8px; font-size:12px; background:rgba(0,0,0,.55); padding:4px 6px; border-radius:8px }

    /* Result boxes */
    .result{ margin-top:14px; padding:14px; background:#101018; border:1px solid var(--r1-neon); border-radius:14px; display:none }
    .result.show{ display:block }

    /* Utility visibility */
    .hidden{ display:none !important }

    /* Message box */
    #message-box{ backdrop-filter: blur(8px) }

    /* R1 helpers mapping frühere Tailwind-Klassen */
    .text-center{text-align:center}
    .mt-4{margin-top:1rem}
    .pt-2{padding-top:.5rem}
    .pb-4{padding-bottom:1rem}
  </style>

  <!-- ZXing für Barcode Scan (beibehalten) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
</head>
<body>
  <div id="app-container" class="container stack-6">
    <!-- Header -->
    <header class="app-header">
      <h1 class="app-title">DISCOGS R1 LIVE</h1>
      <p class="app-sub">Manage &amp; Scan Your Vinyls</p>
    </header>

    <!-- 1) Auth View -->
    <div id="auth-view" class="card p stack-6">
      <h2 class="app-title" style="font-size:1.35rem; text-shadow:none; -webkit-text-fill-color:unset; color:var(--r1-neon); background:none">1. Connect Discogs</h2>
      <p style="color:var(--r1-dim); font-size:.95rem">Gib <span style="color:var(--r1-neon); font-weight:700">Personal Access Token</span> und Benutzername ein, um Discogs zu verbinden.</p>
      <input id="discogsToken" class="field" type="text" placeholder="Your Discogs Personal Access Token" />
      <input id="discogsUsername" class="field" type="text" placeholder="Your Discogs Username" />
      <button class="btn btn-primary btn-block" onclick="saveAndLoadCollection()">Authenticate &amp; Load Collection</button>
      <button class="btn btn-ghost btn-block" onclick="logoutAndReset()">Logout &amp; Clear Credentials</button>
    </div>

    <!-- Main Content (hidden bis Auth) -->
    <div id="main-content" class="hidden">
      <!-- Tabs -->
      <div class="tabs">
        <button id="tabCollection" class="tab" onclick="showView('collection')">My Records</button>
        <button id="tabScanner" class="tab" onclick="showView('scanner')">Live Scan</button>
        <button id="tabManualSearch" class="tab" onclick="showView('manualSearch')">Manual Search</button>
      </div>

      <!-- Collection View -->
      <div id="collection-view" class="view stack-4 mt-4">
        <h2 style="color:#d6d6db; font-weight:800; font-size:1.25rem">Latest 50 Records</h2>
        <button class="btn btn-ghost btn-block" onclick="loadCollection()">Refresh Collection</button>
        <div id="collection-list" class="grid"></div>
        <p id="loading-message" class="hidden" style="text-align:center; color:#8f90a0; padding:24px 0">Loading records...</p>
      </div>

      <!-- Scanner View -->
      <div id="scanner-view" class="view hidden card p stack-4" style="border:1px solid var(--r1-border)">
        <h2 class="app-title" style="font-size:1.35rem; text-shadow:none; -webkit-text-fill-color:unset; color:var(--r1-neon); background:none">Live Barcode Scanner</h2>
        <div class="scan-frame">
          <video id="scanner-video" style="width:100%; height:100%; object-fit:cover"></video>
          <canvas id="scanner-canvas" class="hidden"></canvas>
          <div class="neon"></div>
          <p id="camera-status" class="scan-status">Status: Stopped</p>
        </div>
        <button id="scanner-toggle-btn" class="btn btn-primary btn-block" onclick="toggleScanner()">Start Camera &amp; Scan</button>
        <div id="search-result-scanner" class="result">
          <h3 style="font-weight:800; color:var(--r1-neon); font-size:1.1rem">Record Found!</h3>
          <p id="result-title-scanner" style="color:#d3d4db; font-size:.95rem"></p>
          <button class="btn btn-primary btn-block" onclick="addRecordToCollection()">Add to Collection</button>
        </div>
      </div>

      <!-- Manual Search View -->
      <div id="manualSearch-view" class="view hidden card p stack-4" style="border:1px solid var(--r1-border)">
        <h2 class="app-title" style="font-size:1.35rem; text-shadow:none; -webkit-text-fill-color:unset; color:var(--r1-neon); background:none">Search by Name/Query</h2>
        <p style="color:var(--r1-dim); font-size:.95rem">Search Discogs by Artist, Title, or Catalog #.</p>
        <input id="manualQueryInput" class="field" type="text" placeholder="Artist, Title, or Catalog Number" />
        <button class="btn btn-primary btn-block" onclick="handleManualSearch()">Search Discogs</button>
        <div id="search-result-manual" class="result">
          <h3 style="font-weight:800; color:var(--r1-neon); font-size:1.1rem">Record Found!</h3>
          <p id="result-title-manual" style="color:#d3d4db; font-size:.95rem"></p>
          <button class="btn btn-primary btn-block" onclick="addRecordToCollection()">Add to Collection</button>
        </div>
      </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="card p" style="position:fixed; left:50%; bottom:18px; transform:translateX(-50%); width:min(92%, 480px); text-align:center; font-weight:700; z-index:50; transition:opacity .3s; opacity:0; pointer-events:none; background:#0f0f15; border:1px solid var(--r1-border)"></div>
  </div>

  <!-- App Logic: Original Script aus der Repo beibehalten -->
  <script type="module">
    const API_BASE = "https://api.discogs.com";
    const messageBox = document.getElementById('message-box');
    const tokenInput = document.getElementById('discogsToken');
    const usernameInput = document.getElementById('discogsUsername');
    const collectionList = document.getElementById('collection-list');
    const loadingMessage = document.getElementById('loading-message');
    const scannerVideo = document.getElementById('scanner-video');
    const cameraStatus = document.getElementById('camera-status');
    const authView = document.getElementById('auth-view');
    const mainContent = document.getElementById('main-content');
    const scannerToggleBtn = document.getElementById('scanner-toggle-btn');
    const manualQueryInput = document.getElementById('manualQueryInput');
    const resultBoxScanner = document.getElementById('search-result-scanner');
    const resultTitleScanner = document.getElementById('result-title-scanner');
    const resultBoxManual = document.getElementById('search-result-manual');
    const resultTitleManual = document.getElementById('result-title-manual');

    let discogsToken = localStorage.getItem('discogsToken') || '';
    let discogsUsername = localStorage.getItem('discogsUsername') || '';
    let currentSearchResult = null;
    let mediaStream = null;
    let codeReader = null;

    function showMessage(text, isError = false) {
      messageBox.textContent = text;
      messageBox.style.opacity = '1';
      messageBox.style.pointerEvents = 'auto';

<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=240,height=282,user-scalable=no,maximum-scale=1.0,initial-scale=1.0" />
    <title>Discogs R1 Live Manager</title>
    <style>
      :root{ --r1-bg:#0b0b0f; --r1-surface:#12131a; --r1-card:#191a22; --r1-elev:#202230; --r1-neon:#ff6600; --r1-neon-2:#ff8a3d; --r1-text:#e9e9ee; --r1-dim:#a2a2b0; --r1-border:#2b2c39; --r1-danger:#e5484d; --radius-xl:12px; --radius-lg:10px; --radius-md:8px; --shadow-1:0 6px 20px rgba(0,0,0,.35); --pad-v:6px; --pad-h:10px; --gap:6px; --ctl-h:34px; }
      html, body{ width:240px; height:282px; margin:0; padding:0; overflow:hidden; background: radial-gradient(800px 520px at 70% -10%, rgba(255,102,0,.08), transparent 60%), var(--r1-bg); color:var(--r1-text); font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; font-size:12px; line-height:1.35; letter-spacing:.1px; }
      h1.app-title{ margin:0; font-size:1.1rem; font-weight:900; letter-spacing:.2px; background: linear-gradient(90deg, var(--r1-neon), var(--r1-neon-2)); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow: 0 0 8px rgba(255,102,0,.16); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      h2.app-section{ margin:0; font-size:1.05rem; font-weight:800; color:var(--r1-neon); }
      .text{ font-size:.95rem; color:var(--r1-dim); margin:0; }
      .label{ font-size:.9rem; color:#cfd0d8 }
      #app-container{ width:240px; height:282px; padding: var(--pad-v) var(--pad-h); box-sizing:border-box; overflow:hidden; display:flex; flex-direction:column; gap:var(--gap); }
      .app-header{ text-align:center; padding:0; display:flex; flex-direction:column; gap:2px; }
      .app-sub{ margin:0; color:var(--r1-dim); font-size:.8rem }
      .row{ display:flex; gap:6px; align-items:stretch; }
      .grow{ flex:1 1 0; min-width:0; }
      .card{ background: linear-gradient(180deg, var(--r1-card), var(--r1-elev)); border:1px solid var(--r1-border); border-radius:var(--radius-xl); box-shadow:var(--shadow-1); padding: var(--pad-v) var(--pad-h); display:flex; flex-direction:column; gap:var(--gap); }
      .field{ width:100%; height:var(--ctl-h); background:#0f1016; color:var(--r1-text); border:1px solid var(--r1-border); border-radius:var(--radius-lg); padding:0 10px; outline:none; transition: .2s border-color, .2s box-shadow, .2s transform; font-size:.9rem; box-sizing:border-box; }
      .field::placeholder{ color:#7b7b86 }
      .field:focus{ border-color:var(--r1-neon); box-shadow:0 0 0 2px rgba(255,102,0,.18); transform: translateY(-1px) }
      .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.3rem; height:var(--ctl-h); border-radius:var(--radius-lg); font-weight:700; cursor:pointer; user-select:none; transition:.18s transform, .18s box-shadow, .18s filter; font-size:.9rem; padding:0 10px; border:1px solid transparent; box-sizing:border-box; }
      .btn-primary{ background: linear-gradient(180deg, var(--r1-neon), #e25700); color:#fff; border:none; box-shadow:0 4px 12px rgba(255,102,0,.22); }
      .btn-ghost{ background:#1b1c27; color:#fff; border:1px solid var(--r1-border); }
      .btn:hover{ transform: translateY(-1px) }
      .btn:active{ transform: translateY(0) }
      .tabs{ display:flex; gap:4px; background:#171722; padding:4px; border-radius:10px; border:1px solid var(--r1-border) }
      .tab{ flex:1; padding:6px; border-radius:8px; color:#cfcfd6; background:transparent; border:0; cursor:pointer; font-size:.75rem; height:26px }
      .tab.active{ background:var(--r1-neon); color:#fff }
      .view{ overflow:hidden; max-height:none; }
      .scan-frame{ position:relative; width:100%; height:92px; background:black; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
      .scan-frame .neon{ position:absolute; inset:0; border:2px dashed var(--r1-neon); opacity:.8; margin:4px; border-radius:10px; pointer-events:none }
      .scan-status{ position:absolute; top:4px; left:4px; font-size:.7rem; background:rgba(0,0,0,.55); padding:2px 4px; border-radius:6px }
      #message-box{ position:fixed; left:50%; bottom:4px; transform:translateX(-50%); width:220px; text-align:center; font-weight:700; z-index:50; transition:opacity .3s; opacity:0; pointer-events:none; background:#0f0f15; border:1px solid var(--r1-border); border-radius:10px; padding:4px 6px; }
      .hidden{ display:none !important }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
  </head>
  <body>
    <div id="app-container">
      <header class="app-header">
        <h1 class="app-title">DISCOGS R1 LIVE</h1>
        <p class="app-sub">Manage & Scan Your Vinyls</p>
      </header>
      <div class="card" id="auth-view">
        <h2 class="app-section">1. Connect Discogs</h2>
        <p class="text">Gib <span style="color:var(--r1-neon); font-weight:700">Personal Access Token</span> und Benutzername ein.</p>
        <input class="field" id="discogsToken" placeholder="Your Discogs Personal Access Token" type="text" />
        <input class="field" id="discogsUsername" placeholder="Your Discogs Username" type="text" />
        <div class="row">
          <button class="btn btn-primary grow" id="btn-auth">Authentifizieren</button>
          <button class="btn btn-ghost grow" id="btn-logout">Abmelden</button>
        </div>
      </div>
      <div class="hidden" id="main-content">
        <div class="tabs">
          <button class="tab active" id="tabCollection">My Records</button>
          <button class="tab" id="tabScanner">Live Scan</button>
          <button class="tab" id="tabManualSearch">Manual Search</button>
        </div>
        <div class="view" id="collection-view">
          <h2 class="app-section" style="color:#d6d6db">Latest 50 Records</h2>
          <div class="row">
            <button class="btn btn-ghost grow" id="btn-refresh">Refresh</button>
          </div>
          <div id="collection-list" style="display:grid; gap:6px"></div>
          <p class="text hidden" id="loading-message" style="text-align:center; color:#8f90a0;">Loading records...</p>
        </div>
        <div class="hidden card" id="scanner-view" style="padding:6px 10px; border:1px solid var(--r1-border)">
          <h2 class="app-section">Live Barcode Scanner</h2>
          <div class="scan-frame">
            <video id="scanner-video" style="width:100%; height:100%; object-fit:cover"></video>
            <canvas class="hidden" id="scanner-canvas"></canvas>
            <div class="neon"></div>
            <p class="scan-status" id="camera-status">Status: Stopped</p>
          </div>
          <button class="btn btn-primary" id="scanner-toggle-btn" style="width:100%">Start Camera</button>
          <div class="hidden" id="search-result-scanner" style="margin-top:6px; padding:6px; background:#101018; border:1px solid var(--r1-neon); border-radius:10px;">
            <h3 class="label" style="font-weight:800; color:var(--r1-neon)">Record Found!</h3>
            <p class="text" id="result-title-scanner" style="color:#d3d4db"></p>
            <button class="btn btn-primary" style="width:100%">Add to Collection</button>
          </div>
        </div>
        <div class="hidden card" id="manualSearch-view" style="padding:6px 10px; border:1px solid var(--r1-border)">
          <h2 class="app-section">Search by Name/Query</h2>
          <p class="text">Search Discogs by Artist, Title, or Catalog #.</p>
          <input class="field" id="manualQueryInput" placeholder="Artist, Title, or Catalog Number" type="text" />
          <button class="btn btn-primary" id="btn-manual-search" style="width:100%">Search Discogs</button>
          <div class="hidden" id="search-result-manual" style="margin-top:6px; padding:6px; background:#101018; border:1px solid var(--r1-neon); border-radius:10px;">
            <h3 class="label" style="font-weight:800; color:var(--r1-neon)">Record Found!</h3>
            <p class="text" id="result-title-manual" style="color:#d3d4db"></p>
            <button class="btn btn-primary" style="width:100%">Add to Collection</button>
          </div>
        </div>
      </div>
      <div id="message-box"></div>
    </div>
    <script type="module">
      const API_BASE = "https://api.discogs.com";
      const messageBox = document.getElementById('message-box');
      const tokenInput = document.getElementById('discogsToken');
      const usernameInput = document.getElementById('discogsUsername');
      const collectionList = document.getElementById('collection-list');
      const loadingMessage = document.getElementById('loading-message');
      const scannerVideo = document.getElementById('scanner-video');
      const cameraStatus = document.getElementById('camera-status');
      const authView = document.getElementById('auth-view');
      const mainContent = document.getElementById('main-content');
      const scannerToggleBtn = document.getElementById('scanner-toggle-btn');
      const manualQueryInput = document.getElementById('manualQueryInput');
      const resultBoxScanner = document.getElementById('search-result-scanner');
      const resultTitleScanner = document.getElementById('result-title-scanner');
      const resultBoxManual = document.getElementById('search-result-manual');
      const resultTitleManual = document.getElementById('result-title-manual');

      let discogsToken = localStorage.getItem('discogsToken') || '';
      let discogsUsername = localStorage.getItem('discogsUsername') || '';
      let currentSearchResult = null;
      let mediaStream = null;
      let codeReader = null;

      function showMessage(text, isError = false) {
        messageBox.textContent = text;
        messageBox.style.opacity = '1';
        messageBox.style.pointerEvents = 'auto';
        messageBox.style.color = isError ? '#ff8a8a' : '#a6ffb2';
        setTimeout(() => { messageBox.style.opacity = '0'; messageBox.style.pointerEvents = 'none'; }, 2500);
      }

      function setActiveTab(name){
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        const id = name==='collection' ? 'tabCollection' : name==='scanner' ? 'tabScanner' : 'tabManualSearch';
        const btn = document.getElementById(id); if(btn) btn.classList.add('active');
      }
      function showView(name){
        document.getElementById('collection-view').classList.toggle('hidden', name!=='collection');
        document.getElementById('scanner-view').classList.toggle('hidden', name!=='scanner');
        document.getElementById('manualSearch-view').classList.toggle('hidden', name!=='manualSearch');
        setActiveTab(name);
        if(name!=='scanner') stopScanner();
      }

      async function discogsFetch(url, options={}){
        const headers = Object.assign({
          'Authorization': `Discogs token=${discogsToken}`,
          'User-Agent': `RabbitR1_DiscogsLiveApp/1.0 (User: ${discogsUsername})`
        }, options.headers||{});
        try{
          const res = await fetch(url, {...options, headers});
          if(res.status===401||res.status===403){
            throw new Error('Authentication failed (401/403)');
          }
          if(res.status===429){ throw new Error('Rate limit exceeded (429)'); }
          if(!res.ok){ const t = await res.text(); throw new Error(`API error ${res.status}: ${t?.slice(0,200)}`); }
          const ct = res.headers.get('content-type')||''; return ct.includes('application/json')? res.json(): res.text();
        }catch(err){ console.error('Fetch Error:', err); showMessage(`API Request Failed: ${err.message}`, true); return null; }
      }

      async function loadCollection(){
        if(!discogsToken || !discogsUsername){
          authView.classList.remove('hidden');
          mainContent.classList.add('hidden');
          showMessage('Bitte Token und Benutzername eingeben.', true);
          return;
        }
        authView.classList.add('hidden');
        mainContent.classList.remove('hidden');
        showView('collection');
        loadingMessage.classList.remove('hidden');
        collectionList.innerHTML = '';
        const url = `${API_BASE}/users/${discogsUsername}/collection/folders/0/releases?per_page=50&sort=added&sort_order=desc`;
        const data = await discogsFetch(url);
        loadingMessage.classList.add('hidden');
        if(data && data.releases){
          if(data.releases.length===0){ collectionList.innerHTML = '<p class="text" style="text-align:center">Collection leer oder privat.</p>'; return; }
          data.releases.forEach(r=>{
            const item = document.createElement('div');
            item.className = 'card';
            const info = r.basic_information;
            const artist = (info.artists||[]).map(a=>a.name).join(', ');
            const title = info.title;
            const year = info.year||'N/A';
            item.innerHTML = `<div style="display:flex; gap:8px; align-items:center">
              <img src="${info.thumb||''}" onerror="this.style.display='none'" style="width:46px;height:46px;object-fit:cover;border-radius:8px;border:1px solid #2d2d39" alt=""
